pipeline:

  notify-start:
    image: plugins/slack
    secrets: [slack_webhook]
    webhook: "${SLACK_WEBHOOK}"
    channel: zenbot
    template: >
        Started build #{{build.number}} for *{{repo.name}}*. {{build.link}}

  tests:
    image: python:2.7.13
    commands:
      - pip install --no-cache-dir -r requirements.txt
      - pip install -U pytest
      - python -m pip install flake8
      - py.test -s maya
      - flake8 maya
      - python maya-runner.py --help
    environment:
      - ENVIRONMENT=test

  build-docker-image:
    image: plugins/docker
    repo: evert0n/maya
    secrets: [ docker_username, docker_password ]
    dockerfile: Dockerfile
    tags:
      - latest

  notify-end:
    image: plugins/slack
    secrets: [slack_webhook]
    webhook: "${SLACK_WEBHOOK}"
    channel: zenbot
    template: >
      {{#success build.status}}
        Build #{{build.number}} for *{{repo.name}}* succeeded. Good job. {{build.link}}
      {{else}}
        Build #{{build.number}} for *{{repo.name}}* failed. Fix me please. {{build.link}}
      {{/success}}
    when:
      status: [ success, failure ]
